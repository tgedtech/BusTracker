<!DOCTYPE html>
<html lang="en" data-theme="nord">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Developer Control Panel - BusTracker</title>
    <!-- Include Tailwind CSS and DaisyUI from CDN for styling -->
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@5" rel="stylesheet" type="text/css" />
    <!-- Include DaisyUI Themes -->
    <link href="https://cdn.jsdelivr.net/npm/daisyui@5/themes.css" rel="stylesheet" type="text/css" />
    <!-- Google Fonts Import -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Signika:wght,GRAD@300..700,-30..0&display=swap"
      rel="stylesheet"
    />
    <!-- Custom CSS -->
    <style>
      body {
        font-family: "Signika", sans-serif;
      }
      h1 {
        font-weight: 700;
        font-size: 2rem;
      }
    </style>
  </head>
  <body>
    <div class="w-full flex justify-center m-4">
      <!-- Main container for all body content -->
      <div class="w-4/5">
        <!-- Top Navbar -->
        <div class="navbar bg-base-100 shadow-sm mb-4">
          <div class="flex-1">
            <a class="btn btn-ghost text-xl">Developer Control Panel</a>
          </div>
          <div class="flex-none">
            <ul class="menu menu-horizontal px-1">
              <li><a href="devPanel.html">Dev Panel</a></li>
              <li><a href="adminPanel.html">Admin Panel</a></li>
            </ul>
          </div>
          <div class="flex-none">
            <button class="btn btn-square btn-ghost">
              <img src="https://cdn.tged.tech/logos/tg1.svg" alt="Logo" />
            </button>
          </div>
        </div>

        <!-- Admin Section: Database Schema Management -->
        <section id="admin-section" class="p-4 mt-8 border-t border-base-content/10">
          <h2 class="text-2xl font-bold mb-4">Admin - Schema Management</h2>
          <!-- Form to Add a New Column -->
          <div class="mb-6">
            <h3 class="text-xl font-semibold">Add New Column</h3>
            <form id="add-column-form" class="space-y-2">
              <!-- Table Name: Drop-down populated from the backend -->
              <div>
                <label for="tableName" class="block text-sm">Table Name:</label>
                <select id="tableName" class="input input-bordered w-full">
                  <option value="">Loading tables...</option>
                </select>
              </div>
              <!-- Column Name: Text input with on-blur validation -->
              <div>
                <label for="columnName" class="block text-sm">Column Name:</label>
                <input id="columnName" type="text" class="input input-bordered w-full" placeholder="New column name" />
                <p id="columnNameError" class="text-red-500 text-xs"></p>
              </div>
              <!-- Data Type: Selector with fixed options -->
              <div>
                <label for="dataType" class="block text-sm">Data Type:</label>
                <select id="dataType" class="input input-bordered w-full">
                  <option value="STRING">STRING</option>
                  <option value="INTEGER">INTEGER</option>
                  <option value="DATE">DATE</option>
                  <option value="BOOLEAN">BOOLEAN</option>
                  <option value="JSONB">JSONB</option>
                </select>
              </div>
              <button type="submit" class="btn btn-primary">Add Column</button>
            </form>
            <div id="add-column-result" class="mt-2 text-sm"></div>
          </div>
          <!-- Future admin functionality can be added here: update or delete records, view current schema, etc. -->

          <script>
            // Helper: Fetch list of table names from the backend.
            async function fetchTables() {
              try {
                const res = await fetch('http://localhost:4000/admin/schema/tables');
                if (!res.ok) {
                  throw new Error('Failed to fetch tables.');
                }
                const tables = await res.json();
                return tables; // Expected to return an array, e.g., ["access_codes", "other_table"]
              } catch (error) {
                console.error("Error fetching tables:", error);
                return [];
              }
            }

            // Helper: Fetch existing columns for a given table.
            async function fetchColumns(tableName) {
              try {
                const res = await fetch(`http://localhost:4000/admin/schema/columns?table=${encodeURIComponent(tableName)}`);
                if (!res.ok) {
                  throw new Error('Failed to fetch columns for table ' + tableName);
                }
                const columns = await res.json();
                return columns; // Expected to return an array of column names.
              } catch (error) {
                console.error("Error fetching columns:", error);
                return [];
              }
            }

            // Populate the table name drop-down on page load.
            (async function populateTables() {
              const tableSelect = document.getElementById('tableName');
              const tables = await fetchTables();
              tableSelect.innerHTML = "";
              if (tables.length === 0) {
                tableSelect.innerHTML = "<option value=''>No tables found</option>";
                return;
              }
              tables.forEach(table => {
                const option = document.createElement('option');
                option.value = table;
                option.textContent = table;
                tableSelect.appendChild(option);
              });
            })();

            // Global variable to store current table's column names for validation.
            let currentTableColumns = [];

            // When a table is selected, fetch its columns.
            document.getElementById('tableName').addEventListener('change', async (e) => {
              const selectedTable = e.target.value;
              if (selectedTable) {
                currentTableColumns = await fetchColumns(selectedTable);
                console.log("Existing columns for", selectedTable, ":", currentTableColumns);
              } else {
                currentTableColumns = [];
              }
            });

            // Validate column name on blur.
            document.getElementById('columnName').addEventListener('blur', (e) => {
              const columnName = e.target.value.trim();
              const errorDiv = document.getElementById('columnNameError');
              if (currentTableColumns.includes(columnName)) {
                errorDiv.textContent = "Column name already exists in the selected table.";
              } else {
                errorDiv.textContent = "";
              }
            });

            // Handle the Add Column form submission.
            document.getElementById('add-column-form').addEventListener('submit', async (e) => {
              e.preventDefault();
              const tableName = document.getElementById('tableName').value.trim();
              const columnName = document.getElementById('columnName').value.trim();
              const dataType = document.getElementById('dataType').value.trim();
              
              // Clear existing result message.
              const resultDiv = document.getElementById('add-column-result');
              resultDiv.textContent = "";

              // Validate required fields.
              if (!tableName) {
                resultDiv.textContent = "Please select a table.";
                return;
              }
              if (!columnName) {
                resultDiv.textContent = "Please enter a column name.";
                return;
              }
              if (currentTableColumns.includes(columnName)) {
                resultDiv.textContent = "Column name already exists in the selected table.";
                return;
              }
              if (!dataType) {
                resultDiv.textContent = "Please select a data type.";
                return;
              }
              
              try {
                const response = await fetch('http://localhost:4000/admin/schema/add-column', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({
                    tableName,
                    columnName,
                    dataType
                  })
                });
                
                if (!response.ok) {
                  const errorData = await response.json();
                  resultDiv.textContent = "Error: " + (errorData.error || "Unknown error");
                  return;
                }
                
                const data = await response.json();
                resultDiv.textContent = "Success: " + data.message;
                console.log("Add column response:", data);
              } catch (error) {
                resultDiv.textContent = "Error submitting form: " + error.message;
                console.error("Add column error:", error);
              }
            });
          </script>
        </section>
      </div>
    </div>
  </body>
</html>